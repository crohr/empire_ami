description "Logspout Service"
start on (started docker)
stop on runlevel [!2345]

respawn

respawn limit 100 1

# Needed to find /root/.dockercfg
env HOME="/root"
env IMAGE=finnlabs/logspout@sha256:e39a1cd8deeba2c29ea2b051b9719c6f4b960cc72685f6f11275082890df0071
export HOME

pre-start script
    /usr/bin/docker pull $IMAGE || true
    /usr/bin/docker rm logspout || true
end script

exec /usr/bin/docker run --rm \
        -e LOGSPOUT=ignore \
        --name="logspout" \
	--env-file /etc/logspout/env/logspout.env \
	--volume=/var/run/docker.sock:/tmp/docker.sock \
	$IMAGE tcp://logstash.empire:6379

post-stop script
    /usr/bin/docker stop -t 2 logspout || true
    /usr/bin/docker rm logspout || true
    sleep 2
end script
