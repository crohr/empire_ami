description "Logspout Service"
start on (started docker)
stop on runlevel [!2345]

respawn

respawn limit 100 1

# Needed to find /root/.dockercfg
env HOME="/root"
env IMAGE=finnlabs/logspout@sha256:0e9ca71045b1e09e85a3a33c30b34b93af872dd0f00e5c179c25b9779df58cdb
export HOME

pre-start script
    /usr/bin/docker pull $IMAGE || true
    /usr/bin/docker rm logspout || true
end script

exec /usr/bin/docker run --rm \
        -e LOGSPOUT=ignore \
        --name="logspout" \
	--env-file /etc/logspout/env/logspout.env \
	--volume=/var/run/docker.sock:/tmp/docker.sock \
	$IMAGE tcp://logstash.empire:6379

post-stop script
    /usr/bin/docker stop -t 2 logspout || true
    /usr/bin/docker rm logspout || true
    sleep 2
end script
